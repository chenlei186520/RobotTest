# 机器人静态测试系统 - 使用文档

## 目录
1. [系统概述](#系统概述)
2. [快速开始](#快速开始)
3. [配置文件说明](#配置文件说明)
4. [配置修改指南](#配置修改指南)
5. [测试流程说明](#测试流程说明)
6. [常见问题排查](#常见问题排查)
7. [附录](#附录)

---

## 系统概述

机器人静态测试系统是一个基于Web的测试平台，用于对机器人设备进行静态功能测试。系统支持多种车型（X060、X080、X100、X150等），可进行灯光、语音、按键、触边、显示屏、相机/激光/TOF、举升电机、旋转电机、行走电机等多项测试。

### 主要功能
- 多车型支持（通过配置文件动态配置）
- 自动化测试流程（测试完成后自动跳转）
- 测试报告生成（Excel格式）
- 云端同步（飞书云文档）
- 实时测试结果记录

---

## 快速开始

### 启动系统

1. **方式一：使用批处理文件（推荐）**
   - 双击 `start_app.bat` 文件
   - 系统会自动启动并打开浏览器

2. **方式二：手动启动**
   ```bash
   python app.py
   ```
   然后在浏览器中访问：`http://localhost:5000`

### 测试流程

1. **配置页面（页面A）**
   - 输入车辆ID
   - 输入车辆IP地址
   - 选择设备类型（X060、X080、X100、X150等）
   - 选择具体车辆型号
   - 点击"进入测试"按钮

2. **测试页面（页面B）**
   - 点击"开始测试"按钮
   - 系统自动跳转到第一个TAB（灯光测试）
   - 按顺序完成各项测试
   - 测试完成后自动跳转到测试报告

---

## 配置文件说明

### 主要配置文件

系统的主要配置文件位于项目根目录和 `test_data` 目录下：

```
RobotTest/
├── config.py                    # 主配置文件（IO映射、指令映射等）
├── test_data/
│   ├── TABdisplay_data.csv      # TAB显示配置（车型对应的测试TAB）
│   ├── devices_data.csv         # 设备数据配置（按钮IO映射）
│   ├── TABdisplayconfig.py      # TAB配置解析模块
│   └── ...                      # 其他测试数据文件
└── static/
    └── script.js                # 前端逻辑（一般不需要修改）
```

---

## 配置修改指南

### 1. 修改车型的测试TAB显示

**文件位置：** `test_data/TABdisplay_data.csv`

**说明：** 此文件控制每个车型显示哪些测试TAB，以及相机测试显示哪些设备。

**格式：**
```csv
设备型号,显示TAB策略
X-060-V1-LV-2L-C-1A,"灯光测试
语音测试
按键测试
触边测试
显示屏测试
相机/激光/TOF测试--上下相机/前后激光
举升电机测试
旋转电机测试
行走电机测试"
```

**修改步骤：**

1. 打开 `test_data/TABdisplay_data.csv` 文件
2. 找到对应的设备型号行
3. 修改"显示TAB策略"列的内容
4. 每个TAB占一行，按顺序排列
5. 相机测试的特殊格式：`相机/激光/TOF测试--设备列表`
   - 设备列表用 `/` 分隔，如：`上下相机/前后激光/前后TOF`
   - 支持的设备名称：
     - `上相机`、`下相机`、`前激光`、`后激光`、`前TOF`、`后TOF`
     - 组合名称：`上下相机`、`前后激光`、`前后TOF`

**示例：**
```csv
X-060-V2-LV-2L2T-C-1A,"灯光测试
语音测试
按键测试
触边测试
显示屏测试
相机/激光/TOF测试--上下相机/前后激光/前后TOF
举升电机测试
旋转电机测试
行走电机测试"
```

**注意事项：**
- TAB顺序必须严格按照：灯光测试 → 语音测试 → 按键测试 → 触边测试 → 显示屏测试 → 相机/激光/TOF测试 → 举升电机测试 → 旋转电机测试 → 行走电机测试
- 修改后需要重启系统才能生效

---

### 2. 修改按键测试的IO映射

**文件位置：** `test_data/devices_data.csv`

**说明：** 此文件定义了每个按钮对应的IO索引和值的含义。

**格式：**
```csv
int_data下标,X060/X080,值的含义,X150/X100,值的含义
0,左前急停按钮,0表示按下 1表示弹起,左前急停按钮,0表示按下 1表示弹起
1,前触边,0表示按下 1表示弹起,前触边,0表示按下 1表示弹起
...
```

**修改步骤：**

1. 打开 `test_data/devices_data.csv` 文件
2. 找到对应的按钮名称行
3. 修改对应车型列的IO索引（第一列是int_data下标）
4. 确保按钮名称与系统使用的名称一致

**注意事项：**
- 第一列是 `int_data` 数组的下标（从0开始）
- 按钮名称必须与系统使用的名称完全匹配
- 支持"维修"和"维护"、"键"和"按钮"的自动匹配
- 修改后需要重启系统才能生效

---

### 3. 修改按键测试显示的按钮列表

**文件位置：** `config.py`

**说明：** `BUTTON_TEST_ITEMS_BY_VEHICLE` 字典控制每个车型显示哪些按键测试项。

**位置：** 第124-163行

**修改步骤：**

1. 打开 `config.py` 文件
2. 找到 `BUTTON_TEST_ITEMS_BY_VEHICLE` 字典
3. 找到对应的车型（如 `"X060"`）
4. 修改按钮ID列表

**支持的按钮ID：**
- `front_right_confirm` - 右前确认按钮
- `back_right_confirm` - 右后确认按钮
- `front_right_maintenance` - 右前维修按钮
- `back_right_maintenance` - 右后维修按钮
- `front_right_emergency` - 右前急停按钮
- `back_right_emergency` - 右后急停按钮
- `front_left_emergency` - 左前急停按钮
- `back_left_emergency` - 左后急停按钮

**示例：**
```python
BUTTON_TEST_ITEMS_BY_VEHICLE = {
    "X060": [
        "front_right_maintenance",  # 右前维护按钮
        "front_left_emergency",      # 左前急停按钮
        "front_right_confirm",       # 右前确认按钮
        "back_right_maintenance",    # 右后维护按钮
        "back_right_emergency",      # 右后急停按钮
        "back_right_confirm"         # 右后确认按钮
    ],
    # ... 其他车型
}
```

**注意事项：**
- 按钮ID必须与 `devices_data.csv` 中的按钮名称对应
- 修改后需要重启系统才能生效

---

### 4. 修改按键测试的IO索引映射

**文件位置：** `config.py`

**说明：** `BUTTON_IO_INDEX_MAP_BY_VEHICLE` 字典定义了每个按钮对应的IO索引（备用配置，优先使用CSV文件）。

**位置：** 第28-68行

**修改步骤：**

1. 打开 `config.py` 文件
2. 找到 `BUTTON_IO_INDEX_MAP_BY_VEHICLE` 字典
3. 找到对应的车型
4. 修改按钮ID对应的IO索引值

**示例：**
```python
BUTTON_IO_INDEX_MAP_BY_VEHICLE = {
    "X060": {
        "front_right_confirm": 4,      # 右前确认按钮对应的IO索引
        "back_right_confirm": 11,       # 右后确认按钮对应的IO索引
        "front_right_maintenance": 2,   # 右前维修按钮对应的IO索引
        "back_right_maintenance": 9,    # 右后维修按钮对应的IO索引
        "back_right_emergency": 10,     # 右后急停按钮对应的IO索引
        "front_left_emergency": 3,      # 左前急停按钮对应的IO索引
    },
    # ... 其他车型
}
```

**注意事项：**
- IO索引是 `int_data` 数组的下标（从0开始）
- 此配置是备用配置，系统优先使用 `devices_data.csv` 文件
- 修改后需要重启系统才能生效

---

### 5. 修改触边测试的IO索引映射

**文件位置：** `config.py`

**说明：** `TOUCH_IO_INDEX_MAP_BY_VEHICLE` 字典定义了触边测试的IO索引。

**位置：** 第70-89行

**修改步骤：**

1. 打开 `config.py` 文件
2. 找到 `TOUCH_IO_INDEX_MAP_BY_VEHICLE` 字典
3. 找到对应的车型
4. 修改触边ID对应的IO索引值

**示例：**
```python
TOUCH_IO_INDEX_MAP_BY_VEHICLE = {
    "X060": {
        "front_touch": 1,      # 前触边对应的IO索引
        "back_touch": 8,       # 后触边对应的IO索引
    },
    # ... 其他车型
}
```

---

### 6. 修改相机/激光/TOF设备的IP地址

**文件位置：** `config.py`

**说明：** `CAMERA_IP_MAP_BY_VEHICLE` 字典定义了每个设备的IP地址。

**位置：** 第328-349行

**修改步骤：**

1. 打开 `config.py` 文件
2. 找到 `CAMERA_IP_MAP_BY_VEHICLE` 字典
3. 找到对应的车型
4. 修改设备ID对应的IP地址

**支持的设备ID：**
- `upper_camera` - 上相机
- `lower_camera` - 下相机
- `front_laser` - 前激光
- `rear_laser` - 后激光
- `front_tof` - 前TOF
- `rear_tof` - 后TOF

**示例：**
```python
CAMERA_IP_MAP_BY_VEHICLE = {
    "X100": {
        "upper_camera": "192.168.1.60",   # 上相机IP地址
        "lower_camera": "192.168.1.61",   # 下相机IP地址
        "front_laser": "192.168.1.100",   # 前激光IP地址
        "rear_laser": "192.168.1.88",     # 后激光IP地址
        "front_tof": "10.2.129.234",      # 前TOF IP地址
        "rear_tof": "10.2.129.239"        # 后TOF IP地址
    },
    # ... 其他车型
}
```

---

### 7. 修改SSH连接配置

**文件位置：** `config.py`

**说明：** SSH配置用于连接机器人设备执行命令。

**位置：** 第268-274行

**修改步骤：**

1. 打开 `config.py` 文件
2. 找到SSH配置部分
3. 修改用户名、密码等参数

**示例：**
```python
# SSH配置
SSH_USER = "robot"          # SSH用户名
SSH_PASSWORD = "robot"      # SSH密码
SSH_TIMEOUT = 10            # SSH连接超时时间（秒）
SSH_KEY_PATH = None         # SSH密钥路径（如果使用密钥认证）
```

**注意事项：**
- 如果使用SSH密钥认证，设置 `SSH_KEY_PATH` 为密钥文件路径
- 如果 `SSH_KEY_PATH` 为 `None`，则使用密码认证
- 修改后需要重启系统才能生效

---

### 8. 修改超时时间配置

**文件位置：** `config.py`

**说明：** 各种超时时间配置。

**位置：** 第4-14行

**可修改的参数：**

```python
IO_CHECK_TIMEOUT = 30              # IO检查超时时间（秒）
TOF_SUBSCRIBE_TIMEOUT = 30         # TOF订阅超时时间（秒）
IO_CHECK_INTERVAL = 500            # IO检查轮询间隔（毫秒）
COMMAND_WAIT_TIME = 1000           # 指令发送后等待时间（毫秒）
PING_TEST_TIMEOUT = 10              # Ping测试超时时间（秒）
ROS_COMMAND_TIMEOUT = 35           # rostopic命令超时时间（秒）
```

**修改建议：**
- `IO_CHECK_TIMEOUT`：如果设备响应较慢，可以适当增加
- `TOF_SUBSCRIBE_TIMEOUT`：TOF数据订阅超时时间
- `PING_TEST_TIMEOUT`：网络延迟较大时可以增加

---

### 9. 修改灯光测试指令

**文件位置：** `config.py`

**说明：** `COMMAND_MAP` 字典定义了各种灯光测试的指令。

**位置：** 第188-197行

**修改步骤：**

1. 打开 `config.py` 文件
2. 找到 `COMMAND_MAP` 字典
3. 修改对应的指令字符串

**示例：**
```python
COMMAND_MAP = {
    "red_light": "echo -e -n '\\x5A\\x4E\\x00\\x05\\x04\\x02\\x32\\x01\\x00\\x5D' > /dev/ttyACM0",
    "yellow_light": "echo -e -n '\\x5A\\x4E\\x00\\x05\\x04\\x02\\x32\\x01\\x03\\x1D' > /dev/ttyACM0",
    # ... 其他灯光指令
}
```

**注意事项：**
- 指令格式为十六进制字符串
- 修改后需要重启系统才能生效

---

### 10. 添加新车型

**步骤：**

1. **在 `TABdisplay_data.csv` 中添加新车型**
   ```csv
   设备型号,显示TAB策略
   X-XXX-V1-LV-2L-C-1A,"灯光测试
   语音测试
   按键测试
   ..."
   ```

2. **在 `config.py` 中添加新车型配置**
   - 在 `BUTTON_TEST_ITEMS_BY_VEHICLE` 中添加按钮列表
   - 在 `BUTTON_IO_INDEX_MAP_BY_VEHICLE` 中添加IO映射
   - 在 `TOUCH_IO_INDEX_MAP_BY_VEHICLE` 中添加触边IO映射
   - 在 `CAMERA_IP_MAP_BY_VEHICLE` 中添加设备IP映射（如果需要）

3. **在 `devices_data.csv` 中添加新车型列**
   - 添加新列，如 `X200/X300`
   - 填写对应的按钮名称和IO索引

4. **重启系统**

---

## 测试流程说明

### 标准测试流程

1. **启动系统**
   - 双击 `start_app.bat` 启动系统

2. **配置测试参数（页面A）**
   - 输入车辆ID（如：Y991A100088AK0005）
   - 输入车辆IP地址（如：10.26.7.3）
   - 选择设备类型（X060、X080、X100、X150等）
   - 选择具体车辆型号
   - 点击"进入测试"按钮

3. **开始测试（页面B）**
   - 点击"开始测试"按钮
   - 系统自动跳转到第一个TAB（灯光测试）
   - 测试报告TAB在测试完成前不可手动点击

4. **完成各项测试**
   - 按顺序完成每个TAB的测试
   - 每个测试项完成后，勾选"正常"或"异常"
   - 所有测试项完成后，系统自动跳转到下一个TAB

5. **查看测试报告**
   - 所有测试完成后，系统自动跳转到测试报告
   - 可以下载报告（Excel格式）
   - 可以上传到云端（飞书云文档）

### 测试注意事项

1. **测试顺序**
   - 必须按照TAB顺序完成测试
   - 不能跳过任何测试项
   - 每个测试项必须勾选"正常"或"异常"后才能继续

2. **测试报告**
   - 测试报告在测试完成后才能查看
   - 测试进行中不能手动跳转到测试报告
   - 测试时间从点击"开始测试"时开始记录

3. **网络连接**
   - 确保测试电脑与机器人设备网络连通
   - 确保SSH连接正常（用户名/密码正确）
   - 确保设备IP地址配置正确

---

## 常见问题排查

### 1. SSH连接失败

**问题现象：** 无法连接到设备，提示SSH连接失败

**排查步骤：**
1. 检查设备IP地址是否正确
2. 检查SSH用户名和密码是否正确（`config.py` 中的 `SSH_USER` 和 `SSH_PASSWORD`）
3. 检查网络是否连通（ping设备IP）
4. 检查防火墙设置

**解决方法：**
- 修改 `config.py` 中的SSH配置
- 确保设备SSH服务已启动
- 检查网络连接

---

### 2. 按钮测试无法获取IO数据

**问题现象：** 按钮测试时提示"未获取到有效的IO触发数据"

**排查步骤：**
1. 检查 `devices_data.csv` 中的IO索引是否正确
2. 检查按钮名称是否匹配
3. 检查 `config.py` 中的IO映射配置

**解决方法：**
- 确认按钮名称与CSV文件中的名称一致
- 检查IO索引是否正确（从0开始）
- 检查ROS话题 `/Dev_input_output` 是否正常

---

### 3. 测试TAB顺序不正确

**问题现象：** 测试TAB的显示顺序与预期不符

**排查步骤：**
1. 检查 `TABdisplay_data.csv` 中的TAB顺序
2. 确认TAB名称是否正确

**解决方法：**
- 修改 `TABdisplay_data.csv` 中的TAB顺序
- 确保TAB名称与系统定义的一致
- 重启系统

---

### 4. 相机/激光/TOF测试无法Ping通

**问题现象：** Ping测试失败，无法连接到设备

**排查步骤：**
1. 检查 `config.py` 中的设备IP地址配置
2. 检查网络连接
3. 检查设备是否在线

**解决方法：**
- 修改 `config.py` 中 `CAMERA_IP_MAP_BY_VEHICLE` 的IP地址
- 确保设备与测试电脑在同一网络
- 检查设备是否正常运行

---

### 5. 测试报告不显示某些测试项

**问题现象：** 测试报告中缺少某些测试项

**排查步骤：**
1. 检查该测试项是否在TAB配置中
2. 检查该测试项是否实际执行了测试
3. 检查测试结果是否正确保存

**解决方法：**
- 确保所有测试项都已完成并勾选了结果
- 检查 `TABdisplay_data.csv` 配置
- 重新执行测试

---

### 6. 语音测试无法执行

**问题现象：** 语音测试按钮点击后无响应

**排查步骤：**
1. 检查SSH连接是否正常
2. 检查ROS环境是否正确加载
3. 检查 `rosnode kill` 和 `roslaunch` 命令是否可用

**解决方法：**
- 确保SSH连接正常
- 检查设备上的ROS环境
- 查看系统日志（`logs` 目录）

---

## 附录

### A. 文件结构说明

```
RobotTest/
├── app.py                      # Flask主程序
├── config.py                   # 主配置文件
├── logger_config.py            # 日志配置
├── requirements.txt            # Python依赖
├── start_app.bat              # 启动脚本
├── fs_files_upload.py        # 云端上传脚本
├── apis/                      # API模块
│   ├── button_api.py          # 按键/触边测试API
│   ├── camera_api.py          # 相机/激光/TOF测试API
│   ├── voice_api.py           # 语音测试API
│   ├── lift_motor_api.py      # 举升电机测试API
│   ├── rotation_motor_api.py  # 旋转电机测试API
│   └── walking_motor_api.py   # 行走电机测试API
├── test_data/                 # 测试数据目录
│   ├── TABdisplay_data.csv    # TAB显示配置
│   ├── devices_data.csv       # 设备数据配置
│   ├── TABdisplayconfig.py    # TAB配置解析
│   └── ...                    # 其他测试数据
├── static/                    # 静态文件
│   ├── script.js             # 前端JavaScript
│   ├── style.css             # 样式文件
│   ├── config.js             # 配置页面JavaScript
│   └── config.css            # 配置页面样式
├── templates/                 # HTML模板
│   ├── index.html            # 测试页面
│   └── config.html           # 配置页面
├── logs/                      # 日志目录（自动生成）
└── report/                    # 报告目录（自动生成）
```

### B. 常用配置参数速查表

| 参数 | 位置 | 说明 | 默认值 |
|------|------|------|--------|
| `IO_CHECK_TIMEOUT` | config.py:5 | IO检查超时时间（秒） | 30 |
| `TOF_SUBSCRIBE_TIMEOUT` | config.py:8 | TOF订阅超时时间（秒） | 30 |
| `SSH_USER` | config.py:269 | SSH用户名 | "robot" |
| `SSH_PASSWORD` | config.py:270 | SSH密码 | "robot" |
| `PING_TEST_TIMEOUT` | config.py:362 | Ping测试超时时间（秒） | 10 |

### C. 支持的车型列表

- X060系列
- X080系列
- X100系列
- X150系列

（可通过修改配置文件添加新车型）

### D. 测试项ID对照表

| 测试项 | ID | 说明 |
|--------|-----|------|
| 红灯 | `red_light` | 灯光测试 |
| 黄灯 | `yellow_light` | 灯光测试 |
| 蓝灯 | `blue_light` | 灯光测试 |
| 绿灯 | `green_light` | 灯光测试 |
| 白灯闪烁 | `white_light_blink` | 灯光测试 |
| 示廓灯开 | `clearance_light` | 灯光测试 |
| 示廓灯关 | `clearance_light_off` | 灯光测试 |
| 语音播报 | `voice_broadcast` | 语音测试 |
| 右前确认按钮 | `front_right_confirm` | 按键测试 |
| 右后确认按钮 | `back_right_confirm` | 按键测试 |
| 右前维修按钮 | `front_right_maintenance` | 按键测试 |
| 右后维修按钮 | `back_right_maintenance` | 按键测试 |
| 右前急停按钮 | `front_right_emergency` | 按键测试 |
| 右后急停按钮 | `back_right_emergency` | 按键测试 |
| 左前急停按钮 | `front_left_emergency` | 按键测试 |
| 左后急停按钮 | `back_left_emergency` | 按键测试 |
| 前触边 | `front_touch` | 触边测试 |
| 后触边 | `back_touch` | 触边测试 |
| 触摸功能 | `touch_function` | 显示屏测试 |
| 上相机 | `upper_camera` | 相机/激光/TOF测试 |
| 下相机 | `lower_camera` | 相机/激光/TOF测试 |
| 前激光 | `front_laser` | 相机/激光/TOF测试 |
| 后激光 | `rear_laser` | 相机/激光/TOF测试 |
| 前TOF | `front_tof` | 相机/激光/TOF测试 |
| 后TOF | `rear_tof` | 相机/激光/TOF测试 |

### E. 日志文件位置

- 日志文件保存在 `logs/` 目录下
- 按日期组织：`logs/YYYY-MM-DD/YYYY-MM-DD_HH-MM-SS.txt`
- 日志包含所有控制台输出，带时间戳

### F. 联系支持

如遇到问题，请：
1. 查看日志文件（`logs` 目录）
2. 检查配置文件是否正确
3. 确认网络连接和SSH连接正常
4. 联系技术支持

---

**文档版本：** 1.0  
**最后更新：** 2026-01-15
